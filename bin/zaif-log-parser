#!/usr/bin/env python
# -*- coding: utf-8 -*-
from __future__ import print_function

# datetime,timestamp, currency_pair, action, amount, fee_amount,price,bonus,commen
# 2017/11/7 7:32,1510039948,zaif_jpy,bid,10000,0,0.4698,,,4698,

import sys
import functools
from decimal import *
import simplejson as json
import fileinput

def eprint(*args, **kwargs):
    print(*args, file=sys.stderr, **kwargs)


# Do not use json.load(sys.stdin, ..) because json.load() stops reading before EOL.
inputLines = ""
for line in fileinput.input(): inputLines += line
input = json.loads(inputLines, encoding='utf-8')


#  "4467575": {
#    "currency_pair": "zaif_jpy",
#    "action": "ask",
#    "amount": 1000,
#    "price": 2.83,
#    "fee_amount": 0,
#    "your_action": "bid",
#    "bonus": null,
#    "timestamp": "1513562107",
#    "comment": ""
#  },
def each(subtotal, v):
  record = v[1]
  # bid = buy, ask = sell
  is_sell = record['your_action'] == 'ask'
  sign= (Decimal('-1') if is_sell else Decimal('1'))
  key = record['currency_pair']
  prev = subtotal[key] if key in subtotal else {
    'amount': Decimal('0'), 
    'subtotal_jpy': Decimal('0'), 
    'unit_price': Decimal('0'),
    'benefit': Decimal('0')
  }
  in_amount = Decimal(record['amount'])
  fee_amount = Decimal(record['fee_amount'])
  price = Decimal(record['price'])
  # bid のときは手数料が通貨単位で、買った量から差し引かれる
  diff_amount = in_amount - (fee_amount if not is_sell else Decimal('0'))
  # ask のときは手数料が円単位
  payed_price = fee_amount if is_sell else fee_amount * price
  # 累積通貨資産
  amount = prev['amount'] + sign * diff_amount
  # 購入に使った累計JPY資産
  # 買ったとき: 追加＝購入金額 - 手数料
  # 売ったとき: 減少＝現在のsubtotal_jpyが何割減ったか＝(販売量+手数料) * 購入単価
  subtotal_jpy = Decimal('0')
  if is_sell:
    subtotal_jpy = prev['subtotal_jpy'] - in_amount * prev['unit_price']
  else:
    subtotal_jpy = prev['subtotal_jpy'] + diff_amount * price - payed_price
  # 現時点の単価
  unit_price = subtotal_jpy / amount
  # 現時点の利益(sellで初めて計上)
  diff_benefit=Decimal('0')
  if is_sell:
    diff_benefit = diff_amount * (price - prev['unit_price'])
  benefit = prev['benefit'] + diff_benefit
    
  subtotal[key] = {
    'amount': amount,
    'subtotal_jpy': subtotal_jpy,
    'unit_price': unit_price,
    'benefit': benefit
  }
  eprint(record['your_action'], key, record['amount'], 'by', record['price'], 'jpy',('(benefit: ' + str(diff_benefit) + ')') if is_sell else '')
  eprint('traded:',record)
  eprint(subtotal[key])
  return subtotal

result = functools.reduce(each, sorted(input.items()), {})

def sum_benefit(total, v):
  return total + v[1]['benefit']

result['total'] = {'benefit':functools.reduce(sum_benefit, result.items(), Decimal('0')) }

print(json.dumps(result, use_decimal=True))

